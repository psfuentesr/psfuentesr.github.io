<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Primeros Auxilios Psicol√≥gicos</title>
        <!-- Critical CSS (subset) para acelerar FCP: layout base, tipograf√≠a y modal inicial -->
        <style>
            body{margin:0;font-family:var(--font-base,system-ui,-apple-system,Segoe UI,sans-serif);background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1f2937;}
            .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);} 
            .modal.active{display:flex;} 
            .modal-content{background:#fff;border-radius:15px;max-width:940px;width:100%;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,.25);}
            /* Evita FOIT en inputs clave */
            input,select,button{font-family:inherit;font-size:14px;}
        </style>
    <link rel="stylesheet" href="codigo-interno/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Detectar modo estudiante y aplicar estilos inmediatamente
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const autostart = urlParams.get('autostart');
            const random = urlParams.get('random');
            
            if (mode === 'student' && autostart === 'true' && random === 'true') {
                // Agregar CSS para ocultar la ventana de configuraci√≥n inmediatamente
                const style = document.createElement('style');
                style.id = 'student-mode-override';
                style.textContent = `
                    #simulationConfigWindow,
                    .modal#simulationConfigWindow,
                    .modal.active#simulationConfigWindow {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                `;
                document.head.appendChild(style);
                console.log('üéì Modo estudiante detectado - Ventana de configuraci√≥n oculta');
            }
        })();
    </script>
</head>
<body>
    <!-- Banner Legal / Propiedad Intelectual -->
    <div id="legalBanner">
        <span class="bold">PFA Simulator Web ¬© 2025</span>
        <span class="subtle">Uso estrictamente educativo. Obra protegida. Prohibida redistribuci√≥n o derivaciones sin autorizaci√≥n.</span>
        <a href="LICENSE" target="_blank">Licencia</a>
        <a href="TERMS_OF_USE.md" target="_blank">T√©rminos</a>
        <button id="closeLegalBanner" aria-label="Cerrar aviso legal">Cerrar</button>
    </div>

    <script>
    (function(){
        try {
            const key='pfa_legal_banner_closed_v1';
            const banner=document.getElementById('legalBanner');
            const btn=document.getElementById('closeLegalBanner');
            if(localStorage.getItem(key)==='1'){
                banner.style.display='none';
                // Crear peque√±o bot√≥n para restaurar el banner si fue ocultado previamente
                const restore=document.createElement('button');
                restore.id='pfaRestoreBannerBtn';
                restore.textContent='Aviso Legal';
                restore.style.cssText='position:fixed;bottom:6px;left:6px;z-index:3001;background:#1f2937;color:#fff;border:1px solid #475569;padding:4px 8px;font-size:11px;border-radius:4px;cursor:pointer;opacity:0.75;';
                restore.addEventListener('mouseenter',()=>restore.style.opacity='1');
                restore.addEventListener('mouseleave',()=>restore.style.opacity='0.75');
                restore.addEventListener('click',()=>{localStorage.removeItem(key);banner.style.display='flex';restore.remove();});
                document.body.appendChild(restore);
            }
            btn.addEventListener('click',()=>{banner.style.display='none';localStorage.setItem(key,'1');});
            // Exponer funci√≥n global para restaurar desde consola si se requiere
            window.resetLegalBanner = function(){
                localStorage.removeItem(key);
                banner.style.display='flex';
                const r=document.getElementById('pfaRestoreBannerBtn');
                if(r) r.remove();
            };
        } catch(e) { console.warn('Legal banner init error', e); }
    })();
    </script>
    <!-- Ventana de Configuraci√≥n de Simulaci√≥n -->
    <div id="simulationConfigWindow" class="modal active" data-modal>
        <div class="modal-content">
            <h2>Configuraci√≥n de Simulaci√≥n de PFA</h2>
            <div class="form-group" style="margin-top:8px;">
                <label class="api-key-block">
                    Clave OpenAI / Modo Demo:
                    <div class="api-key-row" aria-hidden="true">
                        <!-- Input moved to app.html (hub). We still inject hidden inputs at runtime if a saved key exists
                             so the simulator script can find elements with the expected IDs and continue operating. -->
                    </div>
                    <small id="apiKeyHint" class="api-hint">La clave se ingresa desde la p√°gina principal (app.html) o activa "Demo" para respuestas simuladas.</small>
                    <small class="api-note">La clave solo vive en tu navegador (localStorage) y se env√≠a directamente a OpenAI. No pasa por un servidor propio.</small>
                </label>
                <script>
                // Ensure the simulator finds expected elements when the visible input is moved to app.html
                (function(){
                    try{
                        // Prefer URL-supplied key/demo (so navigation from app.html works even on file:// origins)
                        const urlParams = new URLSearchParams(location.search);
                        const keyFromUrl = urlParams.get('pfa_api_key');
                        const demoFromUrl = urlParams.get('pfa_demo_mode');

                        // If there is a key in the URL, use it and persist to localStorage for convenience
                        const saved = keyFromUrl || localStorage.getItem('pfa_api_key');
                        const demoPref = (demoFromUrl !== null ? demoFromUrl : localStorage.getItem('pfa_demo_mode'));

                        if (keyFromUrl) {
                            try { localStorage.setItem('pfa_api_key', keyFromUrl); } catch(e) {}
                        }

                        if(saved && saved.startsWith('sk-')){
                            const hidden = document.createElement('input');
                            hidden.type = 'hidden';
                            hidden.id = 'apiKeyInput';
                            hidden.value = saved;
                            document.body.appendChild(hidden);
                        }

                        if(demoPref !== null){
                            const chk = document.createElement('input');
                            chk.type = 'checkbox';
                            chk.id = 'demoModeToggle';
                            chk.checked = demoPref === '1' || demoPref === 'true';
                            chk.style.display = 'none';
                            document.body.appendChild(chk);
                            // give the simulator script time to attach listeners, then dispatch a change
                            // so the internal demo flag is synced when the page loads.
                            setTimeout(()=>{ try { chk.dispatchEvent(new Event('change', { bubbles: true })); } catch(e){} }, 220);
                        }
                    }catch(e){ console.warn('inject hidden api key failed', e); }
                })();
                </script>
            </div>
            
            <div class="form-group">
                <label for="providerName">Tu nombre (proveedor de PFA):</label>
                <input type="text" id="providerName" placeholder="Ingresa tu nombre completo">
            </div>

            <div class="form-group">
                <label for="difficultySlider">Nivel de dificultad (0‚Äì100): <span id="difficultyValue">50%</span></label>
                <input type="range" id="difficultySlider" min="0" max="100" value="50" step="1">
            </div>

            <div class="form-group">
                <label for="traumaType">Tipo de trauma:</label>
                <select id="traumaType">
                    <option value="Agresi√≥n Sexual">Agresi√≥n Sexual</option>
                    <option value="Ataque F√≠sico">Ataque F√≠sico</option>
                    <option value="Conflicto Armado">Conflicto Armado</option>
                    <option value="Terrorismo">Terrorismo</option>
                    <option value="Desastre Natural">Desastre Natural</option>
                    <option value="Accidente de Tr√°nsito">Accidente de Tr√°nsito</option>
                    <option value="Accidente Dom√©stico">Accidente Dom√©stico</option>
                    <option value="Condici√≥n m√©dica repentina">Condici√≥n m√©dica repentina</option>
                    <option value="Noticias traum√°ticas repentinas">Noticias traum√°ticas repentinas</option>
                    <option value="Incendio">Incendio</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="traumaSetting">Escenario del trauma:</label>
                <select id="traumaSetting">
                    <option value="Casa">Casa</option>
                    <option value="Escuela">Escuela</option>
                    <option value="Zona de combate">Zona de combate</option>
                    <option value="Lugar de trabajo">Lugar de trabajo</option>
                    <option value="Calle">Calle</option>
                    <option value="Naturaleza">Naturaleza</option>
                    <option value="Lugar p√∫blico">Lugar p√∫blico</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="age">Edad del sobreviviente de trauma:</label>
                <select id="age">
                    <option value="Joven Adulto">Joven Adulto</option>
                    <option value="Ni√±o">Ni√±o</option>
                    <option value="Adolescente">Adolescente</option>
                    <option value="Adulto">Adulto</option>
                    <option value="Anciano">Anciano</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="gender">G√©nero del sobreviviente de trauma:</label>
                <select id="gender">
                    <option value="Femenino">Femenino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="No especificado">No especificado</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="randomSimulation">
                    Habilitar simulaci√≥n aleatoria
                </label>
            </div>

            <div class="form-group">
                <label for="challenges">Desaf√≠os de PFA:</label>
                <select id="challenges">
                    <option value="P√©rdida de contacto con la realidad">P√©rdida de contacto con la realidad</option>
                    <option value="Agresi√≥n auto/hetero-dirigida">Agresi√≥n auto/hetero-dirigida</option>
                    <option value="Ausencia de respuesta a est√≠mulos">Ausencia de respuesta a est√≠mulos</option>
                    <option value="Tratamiento de salud mental actual o previo">Tratamiento de salud mental actual o previo</option>
                    <option value="S√≠ntomas invalidantes que no ceden">S√≠ntomas invalidantes que no ceden</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <button id="advancedOptionsBtn" class="btn btn-secondary" data-modal-open="advancedOptionsDialog">Opciones Avanzadas</button>
            <button id="startSimulationBtn" class="btn btn-primary">Iniciar Simulaci√≥n</button>
        </div>
    </div>

    <!-- Ventana de Opciones Avanzadas -->
    <div id="advancedOptionsDialog" class="modal" data-modal>
        <div class="modal-content">
            <h2>Opciones de Configuraci√≥n Avanzadas</h2>
            
            <div class="form-group">
                <label for="education">Nivel educativo:</label>
                <select id="education">
                    <option value="B√°sico">B√°sico</option>
                    <option value="Secundaria">Secundaria</option>
                    <option value="T√©cnico">T√©cnico</option>
                    <option value="Profesional">Profesional</option>
                    <option value="Postgrado">Postgrado</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="civilStatus">Estado civil:</label>
                <select id="civilStatus">
                    <option value="Soltero">Soltero</option>
                    <option value="En una relaci√≥n">En una relaci√≥n</option>
                    <option value="Casado">Casado</option>
                    <option value="Divorciado">Divorciado</option>
                    <option value="Viudo">Viudo</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="network">Red social:</label>
                <select id="network">
                    <option value="Sin familia ni red social">Sin familia ni red social</option>
                    <option value="Red social/familiar restringida">Red social/familiar restringida</option>
                    <option value="Red social y lazos fuertes">Red social y lazos fuertes</option>
                    <option value="Red social y lazos aleatorios">Red social y lazos aleatorios</option>
                </select>
            </div>

            <div class="form-group">
                <label>Vive con:</label>
                <div class="checkbox-group" id="livesWithOptions">
                    <label><input type="checkbox" value="Solo"> Solo</label>
                    <label><input type="checkbox" value="Pareja"> Pareja</label>
                    <label><input type="checkbox" value="Hermanos"> Hermanos</label>
                    <label><input type="checkbox" value="Padres"> Padres</label>
                    <label><input type="checkbox" value="Amigos"> Amigos</label>
                    <label><input type="checkbox" value="Aleatorio"> Combinaci√≥n aleatoria</label>
                </div>
            </div>

            <div class="form-group">
                <label>Hobbies:</label>
                <div class="checkbox-group" id="hobbiesOptions">
                    <label><input type="checkbox" value="Lectura"> Lectura</label>
                    <label><input type="checkbox" value="Deportes"> Deportes</label>
                    <label><input type="checkbox" value="Artes"> Artes</label>
                    <label><input type="checkbox" value="M√∫sica"> M√∫sica</label>
                    <label><input type="checkbox" value="Navegaci√≥n"> Navegaci√≥n</label>
                    <label><input type="checkbox" value="Aleatorio"> Combinaci√≥n aleatoria</label>
                </div>
            </div>

            <div class="form-group">
                <label>Rasgos de Personalidad:</label>
                <div class="personality-sliders">
                    <div class="slider-item">
                        <label>Apertura: <span class="slider-value">50%</span></label>
                        <input type="range" class="personality-slider" data-trait="Apertura" min="0" max="100" value="50" step="10">
                    </div>
                    <div class="slider-item">
                        <label>Conciencia: <span class="slider-value">50%</span></label>
                        <input type="range" class="personality-slider" data-trait="Conciencia" min="0" max="100" value="50" step="10">
                    </div>
                    <div class="slider-item">
                        <label>Extroversi√≥n: <span class="slider-value">50%</span></label>
                        <input type="range" class="personality-slider" data-trait="Extroversi√≥n" min="0" max="100" value="50" step="10">
                    </div>
                    <div class="slider-item">
                        <label>Amabilidad: <span class="slider-value">50%</span></label>
                        <input type="range" class="personality-slider" data-trait="Amabilidad" min="0" max="100" value="50" step="10">
                    </div>
                    <div class="slider-item">
                        <label>Neuroticismo: <span class="slider-value">50%</span></label>
                        <input type="range" class="personality-slider" data-trait="Neuroticismo" min="0" max="100" value="50" step="10">
                    </div>
                </div>
                <button id="randomizePersonality" class="btn btn-secondary">Aleatorio</button>
            </div>

            <div class="form-group">
                <label for="medicalConditions">Condiciones m√©dicas:</label>
                <select id="medicalConditions">
                    <option value="S√≠">S√≠</option>
                    <option value="No">No</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="psychiatricConditions">Condiciones psiqui√°tricas:</label>
                <select id="psychiatricConditions">
                    <option value="S√≠">S√≠</option>
                    <option value="No">No</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="medications">Medicamentos:</label>
                <select id="medications">
                    <option value="S√≠">S√≠</option>
                    <option value="No">No</option>
                    <option value="Aleatorio">Aleatorio</option>
                </select>
            </div>

            <button id="closeAdvancedOptions" class="btn btn-primary" data-modal-close>Cerrar</button>
        </div>
    </div>

    <!-- Ventana de Asignaci√≥n de Triage -->
    <div id="triageWindow" class="modal" data-modal>
        <div class="modal-content">
            <div class="triage-content">
                <div class="triage-visual">
                    <img src="assets/asignacion.png" alt="Operadora preparando asignaci√≥n" class="triage-photo" id="triagePhoto" loading="lazy" />
                    <div class="nurse-badge"><i class="fas fa-user-nurse"></i></div>
                </div>
                <div class="triage-message" id="triageMessage"></div>
            </div>
            <button id="acceptCaseBtn" class="btn btn-primary" data-modal-close>Aceptar Caso</button>
        </div>
    </div>

    <!-- Ventana Principal de Simulaci√≥n -->
    <div id="simulationWindow" class="modal" data-modal>
        <div class="modal-content simulation-content">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>Chat de Primeros Auxilios Psicol√≥gicos</h3>
                    <div class="chat-controls">
                        <button id="resourcesBtn" class="btn btn-secondary" data-modal-open="resourcesDialog">
                            <i class="fas fa-book"></i> Recursos
                        </button>
                        <button id="pareBtn" class="btn btn-danger" data-modal-open="pareDialog">
                            üö® Derivaci√≥n Urgente (PAREN)
                        </button>
                        <button id="endConversationBtn" class="btn btn-danger">
                            Finalizar Conversaci√≥n
                        </button>
                    </div>
                </div>
                
                <div class="chat-history" id="chatHistory"></div>
                
                <div class="chat-input-container">
                        <!-- API key y modo demo ahora se configuran en la ventana inicial -->
                    <div class="input-group">
                        <textarea id="inputText" placeholder="Ingrese su mensaje aqu√≠ y presione Enter para enviar"></textarea>
                        <button id="sendButton" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="resources-panel">
                <h4>Recursos de Apoyo</h4>
                <div id="resourcesList"></div>
                <button id="uploadMaterialBtn" class="btn btn-secondary" data-modal-open="uploadDialog">
                    <i class="fas fa-upload"></i> Cargar Material
                </button>
            </div>
        </div>
    </div>

    <!-- Ventana de Recursos -->
    <div id="resourcesDialog" class="modal" data-modal>
        <div class="modal-content">
            <h3>Seleccionar Recursos de Apoyo</h3>
            <p>Seleccione los recursos relevantes para este caso:</p>
            
            <div class="resources-list">
                <label><input type="checkbox" value="SAMU (Ambulancia): 131"> SAMU (Ambulancia): 131</label>
                <label><input type="checkbox" value="BOMBEROS: 132"> BOMBEROS: 132</label>
                <label><input type="checkbox" value="CARABINEROS (Polic√≠a): 133"> CARABINEROS (Polic√≠a): 133</label>
                <label><input type="checkbox" value="Polic√≠a de Investigaciones: 134"> Polic√≠a de Investigaciones: 134</label>
                <label><input type="checkbox" value="Centro de Apoyo a V√≠ctimas: 600 818 1000"> Centro de Apoyo a V√≠ctimas: 600 818 1000</label>
                <label><input type="checkbox" value="Salud Responde: 600 360 7777"> Salud Responde: 600 360 7777</label>
                <label><input type="checkbox" value="FONASA: 600 360 3000"> FONASA: 600 360 3000</label>
                <label><input type="checkbox" value="Centro de la Mujer (SERNAM): 800 104 008"> Centro de la Mujer (SERNAM): 800 104 008</label>
                <label><input type="checkbox" value="Defensor√≠a Penal P√∫blica: (2) 2439 6800"> Defensor√≠a Penal P√∫blica: (2) 2439 6800</label>
            </div>
            
            <div class="button-group">
                <button id="copyResourcesBtn" class="btn btn-secondary">Copiar selecci√≥n</button>
                <button id="applyResourcesBtn" class="btn btn-primary" data-modal-close>Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Ventana de Carga de Archivos -->
    <div id="uploadDialog" class="modal" data-modal>
        <div class="modal-content">
            <h3>Cargar Material de Apoyo</h3>
            <p>Seleccione archivos desde su computador para agregar como recursos de apoyo:</p>
            
            <div class="upload-area">
                <div class="upload-drop-zone" id="uploadDropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x"></i>
                    <p>Arrastre archivos aqu√≠ o haga clic para seleccionar</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.mp4,.mp3" style="display: none;">
                </div>
            </div>
            
            <div class="file-list" id="fileList">
                <h4>Archivos seleccionados:</h4>
                <div id="selectedFiles"></div>
            </div>
            
            <div class="button-group">
                <button id="cancelUploadBtn" class="btn btn-secondary" data-modal-close>Cancelar</button>
                <button id="confirmUploadBtn" class="btn btn-primary" data-modal-close>Cargar Archivos</button>
            </div>
        </div>
    </div>

    <!-- Ventana de Criterios PARE -->
    <div id="pareDialog" class="modal" data-modal>
        <div class="modal-content">
            <h3>Seleccionar Criterio PAREN Detectado</h3>
            <p>Selecciona el criterio PAREN que observaste durante la simulaci√≥n:</p>
            
            <select id="pareCriteria">
                <option value="(P) P√©rdida de contacto con la realidad">(P) P√©rdida de contacto con la realidad</option>
                <option value="(A) Agresi√≥n auto/hetero-dirigida">(A) Agresi√≥n auto/hetero-dirigida</option>
                <option value="(R) Ausencia de respuesta a est√≠mulos">(R) Ausencia de respuesta a est√≠mulos</option>
                <option value="(E) Tratamiento psiqui√°trico actual o previo">(E) Tratamiento psiqui√°trico actual o previo</option>
                <option value="(N) S√≠ntomas invalidantes que no ceden">(N) S√≠ntomas invalidantes que no ceden</option>
            </select>
            
            <div class="button-group">
                <button id="confirmPareBtn" class="btn btn-primary" data-modal-close>Confirmar</button>
                <button id="cancelPareBtn" class="btn btn-secondary" data-modal-close>Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Ventana de Men√∫ -->
    <div id="menuWindow" class="modal" data-modal>
        <div class="modal-content">
            <h3>Conversaci√≥n Finalizada</h3>
            <p>La conversaci√≥n ha terminado. Seleccione una opci√≥n para continuar.</p>
            
            <div class="menu-buttons">
                <button id="progressBtn" class="btn btn-secondary">Progreso Anterior</button>
                <button id="feedbackBtn" class="btn btn-primary" data-modal-open="feedbackWindow">Ir al Feedback</button>
                <button id="exportBtn" class="btn btn-secondary">Exportar Conversaci√≥n</button>
                <button id="exitBtn" class="btn btn-danger">Salir</button>
            </div>
        </div>
    </div>

    <!-- Ventana de Feedback -->
    <div id="feedbackWindow" class="modal" data-modal>
        <div class="modal-content feedback-content">
            <div class="feedback-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="reflection">Reflexi√≥n Personal</button>
                    <button class="tab-btn" data-tab="patient">Feedback del Paciente</button>
                    <button class="tab-btn" data-tab="technical">Evaluaci√≥n T√©cnica</button>
                </div>
                
                <div class="tab-content">
                    <!-- Pesta√±a de Reflexi√≥n Personal -->
                    <div id="reflectionTab" class="tab-pane active">
                        <h3>Reflexi√≥n Personal</h3>
                        
                        <div class="form-group">
                            <label>Calificaci√≥n general de la experiencia:</label>
                            <select id="ratingCombo">
                                <option value="1">1 - Muy insatisfactorio</option>
                                <option value="2">2 - Insatisfactorio</option>
                                <option value="3">3 - Neutral</option>
                                <option value="4">4 - Satisfactorio</option>
                                <option value="5">5 - Muy satisfactorio</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Reflexi√≥n personal sobre la experiencia:</label>
                            <textarea id="reflectionText" placeholder="Describa sus pensamientos, sentimientos y aprendizajes durante la simulaci√≥n..."></textarea>
                        </div>
                        
                        <button id="nextToPatientBtn" class="btn btn-primary">Siguiente</button>
                    </div>
                    
                    <!-- Pesta√±a de Feedback del Paciente -->
                    <div id="patientTab" class="tab-pane">
                        <h3>Feedback del Paciente</h3>
                        
                        <div class="form-group">
                            <label>¬øC√≥mo se sinti√≥ el paciente durante la interacci√≥n?</label>
                            <select id="treatmentCombo">
                                <option value="1">1 - Muy inc√≥modo</option>
                                <option value="2">2 - Inc√≥modo</option>
                                <option value="3">3 - Neutral</option>
                                <option value="4">4 - C√≥modo</option>
                                <option value="5">5 - Muy c√≥modo</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Aspectos espec√≠ficos del trato:</label>
                            <div class="aspects-container">
                                <div class="aspect-item">
                                    <label>Empat√≠a:</label>
                                    <input type="range" class="aspect-slider" data-aspect="Empat√≠a" min="1" max="5" value="1">
                                    <span class="aspect-value">1</span>
                                </div>
                                <div class="aspect-item">
                                    <label>Respeto:</label>
                                    <input type="range" class="aspect-slider" data-aspect="Respeto" min="1" max="5" value="1">
                                    <span class="aspect-value">1</span>
                                </div>
                                <div class="aspect-item">
                                    <label>Claridad en la comunicaci√≥n:</label>
                                    <input type="range" class="aspect-slider" data-aspect="Claridad" min="1" max="5" value="1">
                                    <span class="aspect-value">1</span>
                                </div>
                                <div class="aspect-item">
                                    <label>Atenci√≥n y escucha:</label>
                                    <input type="range" class="aspect-slider" data-aspect="Atenci√≥n" min="1" max="5" value="1">
                                    <span class="aspect-value">1</span>
                                </div>
                                <div class="aspect-item">
                                    <label>Seguridad transmitida:</label>
                                    <input type="range" class="aspect-slider" data-aspect="Seguridad" min="1" max="5" value="1">
                                    <span class="aspect-value">1</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Comentarios del paciente sobre la interacci√≥n:</label>
                            <textarea id="patientComments" readonly></textarea>
                        </div>
                        
                        <button id="nextToTechnicalBtn" class="btn btn-primary">Siguiente</button>
                    </div>
                    
                    <!-- Pesta√±a de Evaluaci√≥n T√©cnica -->
                    <div id="technicalTab" class="tab-pane">
                        <h3>Evaluaci√≥n T√©cnica</h3>
                        
                        <div class="feedback-grid">
                            <div class="feedback-block" data-letter="PAREN">
                                <h4>üö® Criterios PAREN (Derivaci√≥n Urgente)</h4>
                                <div class="feedback-text"></div>
                            </div>
                            
                            <div class="feedback-block" data-letter="A">
                                <h4>üü¶ A. Escucha Activa</h4>
                                <div class="feedback-text"></div>
                                <div class="feedback-slider">
                                    <label>Puntaje:</label>
                                    <input type="range" class="score-slider" min="0" max="5" value="0">
                                    <span class="score-value">0</span>
                                </div>
                            </div>
                            
                            <div class="feedback-block" data-letter="B">
                                <h4>üü¶ B. Reentrenamiento Respiratorio</h4>
                                <div class="feedback-text"></div>
                                <div class="feedback-slider">
                                    <label>Puntaje:</label>
                                    <input type="range" class="score-slider" min="0" max="5" value="0">
                                    <span class="score-value">0</span>
                                </div>
                            </div>
                            
                            <div class="feedback-block" data-letter="C">
                                <h4>üü¶ C. Clasificaci√≥n de Necesidades</h4>
                                <div class="feedback-text"></div>
                                <div class="feedback-slider">
                                    <label>Puntaje:</label>
                                    <input type="range" class="score-slider" min="0" max="5" value="0">
                                    <span class="score-value">0</span>
                                </div>
                            </div>
                            
                            <div class="feedback-block" data-letter="D">
                                <h4>üü¶ D. Derivaci√≥n a Redes</h4>
                                <div class="feedback-text"></div>
                                <div class="feedback-slider">
                                    <label>Puntaje:</label>
                                    <input type="range" class="score-slider" min="0" max="5" value="0">
                                    <span class="score-value">0</span>
                                </div>
                            </div>
                            
                            <div class="feedback-block" data-letter="E">
                                <h4>üü¶ E. Psicoeducaci√≥n</h4>
                                <div class="feedback-text"></div>
                                <div class="feedback-slider">
                                    <label>Puntaje:</label>
                                    <input type="range" class="score-slider" min="0" max="5" value="0">
                                    <span class="score-value">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="showSummaryBtn" class="btn btn-primary" data-modal-open="summaryWindow">Pasar al Resumen Final</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventana de Resumen Final -->
    <div id="summaryWindow" class="modal" data-modal>
        <div class="modal-content">
            <h2>Resumen Final de la Evaluaci√≥n</h2>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="patientChart"></canvas>
                    <h4>Evaluaci√≥n del Paciente</h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="technicalChart"></canvas>
                    <h4>Evaluaci√≥n T√©cnica</h4>
                </div>
            </div>
            
            <div class="button-group">
                <button id="backToFeedbackBtn" class="btn btn-secondary" data-modal-close>Volver</button>
                <button id="finishFeedbackBtn" class="btn btn-primary">Finalizar Feedback</button>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loadingIndicator" class="loading-overlay hidden" aria-hidden="true">
        <div class="loading-spinner" aria-label="Cargando"></div>
        <p id="loadingText" role="status" aria-live="polite" aria-atomic="true">Esperando que la enfermera de triage le asigne un caso...</p>
    </div>

                        <!-- Scripts -->
                        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                        <script src="codigo-interno/config.js"></script>
                        <!-- Sistema de Feedback Universal -->
                        <script src="codigo-interno/feedback-widget-v2.js"></script>
                        <!-- Loader robusto con fallback y diagn√≥stico -->
                        <script>
                        (function(){
                            const BOOT_VERSION='loader_v2';
                            const wantDev=/[?&]dev=1/.test(location.search);
                            const primarySrc= wantDev ? 'codigo-interno/script.js' : 'codigo-interno/script.min.js';
                            const altSrc    = wantDev ? 'codigo-interno/script.min.js' : 'codigo-interno/script.js';
                            const tried=[]; window.PFA_BOOT_LOG=[];
                            function log(msg){
                                const line= new Date().toISOString()+ ' ['+BOOT_VERSION+'] '+ msg;
                                window.PFA_BOOT_LOG.push(line);
                                console.log('%cPFA','background:#0ea5e9;color:#fff;padding:2px 4px;border-radius:3px', line);
                            }
                            function inject(src,label){
                                if(tried.includes(src)) return;
                                tried.push(src);
                                log('Cargando '+label+': '+src);
                                const s=document.createElement('script');
                                s.src=src;
                                s.onload=()=>{ log('OK '+label); verifySoon(); };
                                s.onerror=()=>{ log('ERROR '+label); attemptFallback(); };
                                document.head.appendChild(s);
                            }
                            function verifySoon(){
                                setTimeout(()=>{
                                    if(window.pfaSimulator){
                                        log('Inicializaci√≥n detectada (PFASimulator listo).');
                                        // Verificar carga de imagen
                                        const img=document.getElementById('waitingImage');
                                        if(img && !img.complete){
                                            img.addEventListener('error',()=>{ log('Imagen de espera no carg√≥'); });
                                        }
                                        // Preload triage assignment image
                                        const triagePhoto=document.getElementById('triagePhoto');
                                        if(triagePhoto){
                                            if(triagePhoto.complete){ triagePhoto.classList.add('loaded'); }
                                            else {
                                                triagePhoto.style.opacity='0';
                                                triagePhoto.addEventListener('load',()=>{ triagePhoto.style.transition='opacity .6s ease'; triagePhoto.style.opacity='1'; triagePhoto.classList.add('loaded'); });
                                                triagePhoto.addEventListener('error',()=>{ log('triagePhoto no se pudo cargar (assets/asignacion.png)'); triagePhoto.style.opacity='.25'; triagePhoto.style.background='#1e293b'; });
                                            }
                                        }
                                    } else {
                                        log('PFASimulator no presente tras carga. Intentando fallback.');
                                        attemptFallback();
                                        // Intento de inicializaci√≥n defensiva si el script carg√≥ pero no se auto-inicializ√≥
                                        safeLateInit();
                                    }
                                }, 80);
                            }
                            function safeLateInit(){
                                if(window.pfaSimulator) return;
                                try {
                                    if(typeof PFASimulator==='function'){ // en script.js original ser√≠a clase PFASimulator; en min se llama 'e'
                                        window.pfaSimulator = new PFASimulator();
                                        log('Inicializaci√≥n manual tard√≠a (PFASimulator) exitosa.');
                                    } else if(typeof e==='function' && !window.pfaSimulator) { // fallback al nombre minificado
                                        window.pfaSimulator = new e();
                                        log('Inicializaci√≥n manual tard√≠a usando clase minificada (e) exitosa.');
                                    }
                                } catch(err){
                                    log('Error en safeLateInit: '+ (err && err.message ? err.message : err));
                                }
                            }
                            function attemptFallback(){
                                if(window.pfaSimulator) return; // Ya inicializ√≥
                                if(!tried.includes(altSrc)){
                                    log('Intentando fallback: '+altSrc);
                                    inject(altSrc,'fallback');
                                } else {
                                    showFailurePanel();
                                }
                            }
                            function showFailurePanel(){
                                if(window.pfaSimulator || document.getElementById('pfaBootFailure')) return;
                                log('Fallo al cargar ambos scripts. Mostrando panel de error.');
                                const div=document.createElement('div');
                                div.id='pfaBootFailure';
                                div.innerHTML='<strong>Fallo al iniciar la aplicaci√≥n.</strong><br>Intenta recargar, usar <code>?dev=1</code> o revisar la consola.'+
                                  '<div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">'+
                                  '<button id="pfaReloadBtn" style="background:#0ea5e9;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;">Recargar</button>'+
                                  (wantDev?'<button id="pfaSwitchBtn" style="background:#334155;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;">Modo minificado</button>':'<button id="pfaSwitchBtn" style="background:#334155;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;">Modo dev</button>')+
                                  '<button id="pfaLogBtn" style="background:#475569;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;">Ver log</button>'+
                                  '</div>';
                                div.style.cssText='position:fixed;top:0;left:0;right:0;z-index:4000;background:#dc2626;color:#fff;padding:12px;font:13px system-ui,Arial;border-bottom:3px solid #991b1b;box-shadow:0 4px 12px rgba(0,0,0,.35);';
                                document.body.appendChild(div);
                                document.getElementById('pfaReloadBtn').onclick=()=>location.reload();
                                document.getElementById('pfaSwitchBtn').onclick=()=>{
                                    const url=new URL(location.href);
                                    if(wantDev){
                                        url.searchParams.delete('dev');
                                    } else {
                                        url.searchParams.set('dev','1');
                                    }
                                    location.href=url.toString();
                                };
                                document.getElementById('pfaLogBtn').onclick=()=>{
                                    alert((window.PFA_BOOT_LOG||[]).join('\n')); };
                            }
                            // Intento primario
                            inject(primarySrc,'primario');
                            // Timeout de seguridad: si en 2500ms no est√° listo, fallback
                            setTimeout(()=>{ if(!window.pfaSimulator) { log('Timeout de inicializaci√≥n. Activando fallback.'); attemptFallback(); safeLateInit(); } }, 2500);
                        })();
                        </script>
</body>
<script type="module" src="codigo-interno/modalManager.js"></script>
<script>
// Ejemplo: botones futuros pueden usar data-modal-open="advancedOptionsDialog" / data-modal-close
</script>
</html>
