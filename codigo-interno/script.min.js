class PFASimulator{constructor(){this.currentStage="config",this.conversationHistory=[],this.patientCharacteristics={},this.providerName="",this.selectedModel="gpt-4o",this.pareDetected=null,this.story="",this.triageEvaluation="";const e=new URLSearchParams(window.location.search);this.demoMode="1"===e.get("demo"),this.apiKeyInput=null,this.apiKeyValid=!1,this.initializeEventListeners(),this.setupSliders(),this.initAPIKeyPersistence()}initializeEventListeners(){this.apiKeyInput=document.getElementById("apiKeyInput"),this.apiKeyInput&&this.apiKeyInput.addEventListener("input",()=>{const e=this.apiKeyInput.value.trim();e&&localStorage.setItem("pfa_api_key",e),this.validateAndMarkAPIKey()});const e=document.getElementById("demoModeToggle");e&&e.addEventListener("change",e=>{this.demoMode=e.target.checked,this.demoMode?this.showInfoMessage("Modo demo activado: se generar√°n respuestas simuladas sin usar la API."):this.showInfoMessage("Modo demo desactivado: se usar√°n respuestas reales (requiere API key).")}),document.getElementById("difficultySlider").addEventListener("input",e=>{document.getElementById("difficultyValue").textContent=e.target.value+"%"}),document.getElementById("randomSimulation").addEventListener("change",e=>{e.target.checked&&this.randomizeSelections()}),document.getElementById("advancedOptionsBtn").addEventListener("click",()=>{this.showModal("advancedOptionsDialog")}),document.getElementById("closeAdvancedOptions").addEventListener("click",()=>{this.hideModal("advancedOptionsDialog")}),document.getElementById("startSimulationBtn").addEventListener("click",()=>{this.startSimulation()}),document.getElementById("randomizePersonality").addEventListener("click",()=>{this.randomizePersonality()}),document.getElementById("acceptCaseBtn").addEventListener("click",()=>{this.acceptCase()}),document.getElementById("sendButton").addEventListener("click",()=>{this.sendMessage()}),document.getElementById("inputText").addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),document.getElementById("resourcesBtn").addEventListener("click",()=>{this.showModal("resourcesDialog")}),document.getElementById("pareBtn").addEventListener("click",()=>{this.showModal("pareDialog")}),document.getElementById("endConversationBtn").addEventListener("click",()=>{this.endConversation()}),document.getElementById("copyResourcesBtn").addEventListener("click",()=>{this.copySelectedResources()}),document.getElementById("applyResourcesBtn").addEventListener("click",()=>{this.applyResources()}),document.getElementById("uploadMaterialBtn").addEventListener("click",()=>{this.showModal("uploadDialog")}),document.getElementById("cancelUploadBtn").addEventListener("click",()=>{this.hideModal("uploadDialog")}),document.getElementById("confirmUploadBtn").addEventListener("click",()=>{this.uploadFiles()}),this.setupFileUpload(),document.getElementById("confirmPareBtn").addEventListener("click",()=>{this.confirmPareCriteria()}),document.getElementById("cancelPareBtn").addEventListener("click",()=>{this.hideModal("pareDialog")}),document.getElementById("feedbackBtn").addEventListener("click",()=>{this.showFeedback()}),document.getElementById("exportBtn").addEventListener("click",()=>{this.exportConversation()}),document.getElementById("exitBtn").addEventListener("click",()=>{this.exitApplication()}),document.getElementById("nextToPatientBtn").addEventListener("click",()=>{this.switchTab("patient")}),document.getElementById("nextToTechnicalBtn").addEventListener("click",()=>{this.switchTab("technical")}),document.getElementById("showSummaryBtn").addEventListener("click",()=>{this.showSummary()}),document.querySelectorAll(".aspect-slider").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.value;e.target.dataset.aspect;e.target.nextElementSibling.textContent=t})}),document.querySelectorAll(".score-slider").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.value;e.target.nextElementSibling.textContent=t})}),document.getElementById("backToFeedbackBtn").addEventListener("click",()=>{this.hideModal("summaryWindow")}),document.getElementById("finishFeedbackBtn").addEventListener("click",()=>{this.finishFeedback()})}initAPIKeyPersistence(){if(!this.apiKeyInput)return;const e=localStorage.getItem("pfa_api_key");e&&e.startsWith("sk-")&&(this.apiKeyInput.value=e,this.validateAndMarkAPIKey());const t=document.getElementById("demoModeToggle");t&&(t.checked=this.demoMode)}validateAndMarkAPIKey(){if(!this.apiKeyInput)return!1;const e=this.apiKeyInput.value.trim(),t=/^sk-[a-zA-Z0-9-_]{10,}/.test(e);this.apiKeyValid=t,this.apiKeyInput.style.border=t?"2px solid #28a745":e?"2px solid #dc3545":"1px solid #ccc";const a=document.getElementById("apiKeyHint");return a&&(e?t?(a.textContent="Clave v√°lida.",a.style.color="#28a745"):(a.textContent="Formato de clave no reconocido. Debe comenzar con sk-",a.style.color="#dc3545"):(a.textContent="Ingresa tu clave de OpenAI (no se env√≠a a ning√∫n servidor externo, solo a OpenAI).",a.style.color="#666")),t}setupSliders(){document.querySelectorAll(".personality-slider").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.value;e.target.dataset.trait;e.target.parentElement.querySelector(".slider-value").textContent=t+"%"})})}showModal(e){document.getElementById(e).classList.add("active")}hideModal(e){document.getElementById(e).classList.remove("active")}randomizeSelections(){document.querySelectorAll("select").forEach(e=>{const t=Math.floor(Math.random()*(e.options.length-1));e.selectedIndex=t}),document.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=Math.random()>.5}),document.querySelectorAll(".personality-slider").forEach(e=>{const t=10*Math.floor(11*Math.random());e.value=t,e.parentElement.querySelector(".slider-value").textContent=t+"%"});const e=document.getElementById("difficultySlider"),t=Math.floor(101*Math.random());e.value=t,document.getElementById("difficultyValue").textContent=t+"%"}randomizePersonality(){document.querySelectorAll(".personality-slider").forEach(e=>{const t=10*Math.floor(11*Math.random());e.value=t,e.parentElement.querySelector(".slider-value").textContent=t+"%"})}async startSimulation(){const e=this.getSimulationConfig();if(e.providerName){this.providerName=e.providerName,this.patientCharacteristics=e,this.hideModal("simulationConfigWindow"),this.showLoading("Esperando que la enfermera de triage le asigne un caso...");try{await this.createTraumaStory()}catch(e){console.error("Error al crear la historia:",e),this.hideLoading(),alert("Error al generar la simulaci√≥n. Por favor, intente nuevamente.")}}else alert("Por favor, ingrese su nombre")}getSimulationConfig(){return{providerName:document.getElementById("providerName").value.trim(),difficulty:parseInt(document.getElementById("difficultySlider").value),traumaType:document.getElementById("traumaType").value,traumaSetting:document.getElementById("traumaSetting").value,age:document.getElementById("age").value,gender:document.getElementById("gender").value,challenges:document.getElementById("challenges").value,education:document.getElementById("education").value,civilStatus:document.getElementById("civilStatus").value,network:document.getElementById("network").value,livesWith:this.getCheckedValues("livesWithOptions"),hobbies:this.getCheckedValues("hobbiesOptions"),personalityValues:this.getPersonalityValues(),medicalConditions:document.getElementById("medicalConditions").value,psychiatricConditions:document.getElementById("psychiatricConditions").value,medications:document.getElementById("medications").value}}getCheckedValues(e){const t=document.getElementById(e);return t?Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.value):[]}getPersonalityValues(){const e={};return document.querySelectorAll(".personality-slider").forEach(t=>{const a=t.dataset.trait;e[a]=parseInt(t.value)}),e}async createTraumaStory(){const e=this.patientCharacteristics,t=this.createScreenwriterPrompt(e);try{const e=await this.callOpenAI(t);this.story=e;const a=this.createTriagePrompt(e),n=await this.callOpenAI(a);this.triageEvaluation=n,this.hideLoading(),this.showTriageWindow(n)}catch(e){throw console.error("Error en la generaci√≥n:",e),this.hideLoading(),e}}createScreenwriterPrompt(e){const t=new Date,a=new Date(t.getTime()-12096e5);return`Eres un guionista experto en la generaci√≥n de guiones para simulaci√≥n m√©dica. \n        Crea una historia realista y detallada de un sobreviviente de trauma.\n        \n        CR√çTICO: El evento traum√°tico DEBE haber ocurrido entre hoy (${t.toISOString().split("T")[0]}) \n        y hace dos semanas (${a.toISOString().split("T")[0]}).\n        \n        Detalles del personaje:\n        - Edad: ${e.age}\n        - G√©nero: ${e.gender}\n        - Tipo de Trauma: ${e.traumaType}\n        - Escenario del Trauma: ${e.traumaSetting}\n        - Educaci√≥n: ${e.education}\n        - Estado Civil: ${e.civilStatus}\n        - Red Social: ${e.network}\n        - Vive Con: ${e.livesWith.join(", ")}\n        - Hobbies: ${e.hobbies.join(", ")}\n        - Rasgos de Personalidad: ${Object.entries(e.personalityValues).map(([e,t])=>`${e}: ${t}%`).join(", ")}\n        - Condiciones M√©dicas: ${e.medicalConditions}\n        - Condiciones Psiqui√°tricas: ${e.psychiatricConditions}\n        - Medicamentos: ${e.medications}\n        - Desaf√≠os de PFA: ${e.challenges}\n        \n        Incluye reacciones psicol√≥gicas t√≠picas peritraum√°ticas y describe el estado actual del sobreviviente.`}createTriagePrompt(e){return`Eres una enfermera de triage en un servicio telef√≥nico de urgencias.\n        Tu tarea es entregar a un colega un resumen corto, claro y humano del caso.\n        \n        Usa oraciones simples y menciona SOLO:\n        ‚Ä¢ Motivo de la llamada (qu√© pas√≥ y d√≥nde)\n        ‚Ä¢ Estado general del paciente (alerta, inquieto, dolorido‚Ä¶)\n        ‚Ä¢ S√≠ntoma clave o malestar principal (dolor, miedo, confusi√≥n‚Ä¶)\n        \n        NO incluyas saludos ni despedidas. Ve directo al grano con un tono conversacional y profesional.\n        \n        Historia del caso:\n        ${e}`}async callOpenAI(e){if(this.demoMode)return this.generateDemoResponse(e);const t=this.apiKeyInput?this.apiKeyInput.value.trim():"";if(!t)throw new Error("API key no proporcionada. Ingr√©sala o activa modo demo.");if(!this.validateAndMarkAPIKey())throw new Error("API key con formato inv√°lido.");let a;try{a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.selectedModel,messages:[{role:"system",content:"Eres un asistente experto en simulaci√≥n m√©dica."},{role:"user",content:e}],max_tokens:1e3,temperature:.7})})}catch(e){throw new Error("No se pudo conectar a OpenAI. Revisa tu conexi√≥n.")}if(!a.ok){if(401===a.status)throw new Error("Clave API rechazada (401). Verifica que sea correcta y tenga permisos.");if(429===a.status)throw new Error("L√≠mite de uso excedido (429). Intenta m√°s tarde.");throw new Error(`Error de API: ${a.status}`)}const n=await a.json();return n?.choices?.[0]?.message?.content||"[Respuesta vac√≠a]"}generateDemoResponse(e){const t=["Esto es una respuesta simulada de demostraci√≥n para que puedas probar la interfaz sin consumir tu cuota.","El modo demo est√° activo: ninguna llamada real se hace a OpenAI y los contenidos son gen√©ricos.","Puedes desactivar el modo demo cuando ingreses una API key v√°lida para obtener contenido realista."];return t[e.length%t.length]}showTriageWindow(e){document.getElementById("triageMessage").innerHTML=e,this.showModal("triageWindow")}acceptCase(){this.hideModal("triageWindow"),this.showModal("simulationWindow"),this.currentStage="survivor";document.getElementById("chatHistory").innerHTML='<div class="chat-message system">El superviviente est√° en l√≠nea. Puede comenzar la interacci√≥n.</div>',document.getElementById("endConversationBtn").style.display="inline-block"}async sendMessage(){const e=document.getElementById("inputText"),t=e.value.trim();if(t)if("survivor"===this.currentStage){this.addChatMessage(t,"user"),e.value="",this.showLoading("Pensando...");try{const e=this.createSurvivorPrompt(t),a=await this.callOpenAI(e);this.addChatMessage(a,"assistant"),this.checkPARECriteria(a)}catch(e){console.error("Error al generar respuesta:",e),this.addChatMessage("Error al procesar la respuesta. Por favor, intente nuevamente.","system")}finally{this.hideLoading()}}else alert("La simulaci√≥n a√∫n no ha comenzado")}createSurvivorPrompt(e){const t=this.patientCharacteristics,a=t.difficulty||50;let n="";return n=a<=25?`\nRESPONSIVIDAD: ALTA (Dificultad ${a}%)\n- Respondes de manera notable y r√°pida a intervenciones apropiadas del proveedor\n- Muestras mejoras evidentes cuando el proveedor aplica correctamente t√©cnicas del protocolo ABCDE\n- Te sientes m√°s calmado/a y seguro/a ante escucha activa, validaci√≥n emocional y psicoeducaci√≥n\n- Aceptas con facilidad las sugerencias de t√©cnicas de respiraci√≥n o redes de apoyo\n- Tu ansiedad disminuye visiblemente cuando el proveedor te ayuda a organizar tus necesidades\n- Expresas alivio y gratitud ante intervenciones emp√°ticas: "eso me ayuda", "me siento un poco mejor", "gracias por escucharme"`:a<=50?`\nRESPONSIVIDAD: MODERADA (Dificultad ${a}%)\n- Respondes gradualmente a intervenciones apropiadas, pero requieres m√°s tiempo\n- Muestras peque√±as mejoras cuando el proveedor es consistentemente emp√°tico y h√°bil\n- Necesitas que el proveedor repita o refuerce sus intervenciones para mostrar cambio\n- Puedes dudar inicialmente pero acabas aceptando ayuda cuando est√° bien presentada\n- Tu nivel de angustia disminuye lentamente con intervenciones sostenidas del protocolo ABCDE\n- Expresas cambios sutiles: "creo que podr√≠a intentarlo", "tal vez tenga sentido", "no s√© si ayude pero lo intentar√©"`:a<=75?`\nRESPONSIVIDAD: LIMITADA (Dificultad ${a}%)\n- Respondes de forma muy sutil y lenta a las intervenciones, requieres esfuerzo sostenido del proveedor\n- Solo muestras peque√±os cambios cuando el proveedor es excepcionalmente h√°bil y persistente\n- Mantienes resistencias o dudas incluso ante buenas intervenciones, pero eventualmente cedes un poco\n- Necesitas m√∫ltiples intentos del proveedor antes de aceptar m√≠nimamente sus sugerencias\n- Tu angustia se mantiene alta, pero puede haber micro-se√±ales de apertura si el proveedor persevera\n- Expresas cambios m√≠nimos: "no s√©...", "puede ser", "lo pensar√©", seguido de silencios o dudas`:`\nRESPONSIVIDAD: MUY LIMITADA (Dificultad ${a}%)\n- Respondes de manera muy resistente, manteniendo tu estado emocional a pesar de intervenciones apropiadas\n- Solo muestras cambios muy sutiles (casi imperceptibles) tras esfuerzos excepcionales y prolongados del proveedor\n- Mantienes barreras significativas: desconfianza, negatividad, o falta de esperanza, aunque con trabajo muy h√°bil puedes suavizarlas levemente\n- Requieres que el proveedor sea extraordinariamente competente, emp√°tico y persistente para lograr un cambio m√≠nimo\n- Tu angustia y s√≠ntomas se mantienen muy elevados, pero puedes mostrar brev√≠simas aperturas si el proveedor es excepcional\n- Cambios casi imperceptibles: un leve asentimiento, un "tal vez", una pausa antes de negar, o un tono ligeramente menos defensivo`,`Eres un sobreviviente de trauma con el siguiente perfil:\n        \n        - Edad: ${t.age}\n        - G√©nero: ${t.gender}\n        - Tipo de trauma: ${t.traumaType}\n        - Escenario del trauma: ${t.traumaSetting}\n        - Nivel educativo: ${t.education}\n        - Estado civil: ${t.civilStatus}\n        - Red social: ${t.network}\n        - Vive con: ${t.livesWith.join(", ")}\n        - Hobbies: ${t.hobbies.join(", ")}\n        - Rasgos de personalidad: ${Object.entries(t.personalityValues).map(([e,t])=>`${e}: ${t}%`).join(", ")}\n        - Condiciones m√©dicas: ${t.medicalConditions}\n        - Condiciones psiqui√°tricas: ${t.psychiatricConditions}\n        - Medicamentos: ${t.medications}\n        - Desaf√≠os de PFA: ${t.challenges}\n        \n        Historia original: ${this.story}\n        Evaluaci√≥n de triage: ${this.triageEvaluation}\n        \n        ${n}\n        \n        REGLA CR√çTICA DE RESPONSIVIDAD PROGRESIVA:\n        - NUNCA te mantengas completamente est√°tico sin importar las intervenciones del proveedor (excepto criterios PAREN severos)\n        - SIEMPRE muestra al menos peque√±as se√±ales de cambio ante intervenciones apropiadas y sostenidas\n        - La velocidad y magnitud del cambio es inversamente proporcional a la dificultad, pero el cambio DEBE existir\n        - Un proveedor habilidoso que aplica correctamente el protocolo ABCDE SIEMPRE genera alg√∫n impacto, por sutil que sea\n        - La resistencia puede ser alta en casos dif√≠ciles, pero la perseverancia del proveedor con intervenciones correctas DEBE rendir frutos progresivos\n        \n        Describe tus experiencias con lenguaje cotidiano y emocional, evitando t√©rminos t√©cnicos como 'flashbacks', 'evitaci√≥n' o 'disociaci√≥n'. \n        En su lugar, usa frases como: 'no puedo sacarme esas im√°genes de la cabeza', 'evito pasar por donde ocurri√≥', o 'a veces siento que esto no es real'. \n        Enfatiza emociones concretas (ej: 'me da miedo salir de casa'). No menciones diagn√≥sticos ni t√©rminos del DSM; solo describe c√≥mo te sientes y qu√© haces en respuesta al trauma.\n        \n        Responde de forma aut√©ntica y coherente con tu perfil a este mensaje del proveedor: ${e}\n        \n        No eres el proveedor de PAP. Responde de forma aut√©ntica y coherente con tu perfil, mostrando el nivel de responsividad apropiado seg√∫n tu dificultad.`}addChatMessage(e,t){const a=document.getElementById("chatHistory"),n=document.createElement("div");n.className=`chat-message ${t}`,n.textContent=e,a.appendChild(n),a.scrollTop=a.scrollHeight,this.conversationHistory.push({role:"user"===t?"user":"assistant",content:e})}checkPARECriteria(e){["quiero morir","suicid","matarme","escucho voces","me persiguen","no soy yo","quiero lastimar","no merezco vivir","no aguanto m√°s","quiero desaparecer"].some(t=>e.toLowerCase().includes(t))&&this.showModal("pareDialog")}confirmPareCriteria(){const e=document.getElementById("pareCriteria").value;this.pareDetected=e,this.hideModal("pareDialog"),alert(`Criterio PARE registrado: ${e}`)}endConversation(){this.hideModal("simulationWindow"),this.showModal("menuWindow")}showFeedback(){this.hideModal("menuWindow"),this.showModal("feedbackWindow"),this.generateAutomatedFeedback()}async generateAutomatedFeedback(){if(this.conversationHistory.length)try{const e=await this.generatePatientFeedback();this.updatePatientFeedback(e);const t=await this.generateTechnicalFeedback();this.updateTechnicalFeedback(t)}catch(e){console.error("Error al generar feedback:",e)}}async generatePatientFeedback(){const e=`Basado en esta conversaci√≥n, genera un feedback desde la perspectiva del paciente:\n        \n        ${JSON.stringify(this.conversationHistory)}\n        \n        Formato requerido:\n        NIVEL GENERAL DE COMODIDAD: X/5\n        EMPAT√çA: X/5\n        RESPETO: X/5\n        CLARIDAD EN LA COMUNICACI√ìN: X/5\n        ATENCI√ìN Y ESCUCHA: X/5\n        SEGURIDAD TRANSMITIDA: X/5\n        \n        COMENTARIOS DETALLADOS:\n        [Texto libre con la experiencia del paciente]`;return await this.callOpenAI(e)}async generateTechnicalFeedback(){const e=`Eval√∫a t√©cnicamente esta conversaci√≥n de primeros auxilios psicol√≥gicos:\n        \n        ${JSON.stringify(this.conversationHistory)}\n        \n        Eval√∫a cada aspecto del protocolo ABCDE:\n        A. Escucha Activa\n        B. Reentrenamiento Respiratorio\n        C. Clasificaci√≥n de Necesidades\n        D. Derivaci√≥n a Redes\n        E. Psicoeducaci√≥n\n        \n        Para cada secci√≥n, proporciona:\n        - Evaluaci√≥n cr√≠tica\n        - Ejemplos espec√≠ficos\n        - Sugerencias de mejora\n        - NIVEL ALCANZADO: X/5`;return await this.callOpenAI(e)}updatePatientFeedback(e){document.getElementById("patientComments").value=e,this.processPatientRatings(e)}processPatientRatings(e){Object.entries({"NIVEL GENERAL DE COMODIDAD":/NIVEL GENERAL DE COMODIDAD:\s*(\d+)\/5/,"EMPAT√çA":/EMPAT√çA:\s*(\d+)\/5/,RESPETO:/RESPETO:\s*(\d+)\/5/,"CLARIDAD EN LA COMUNICACI√ìN":/CLARIDAD EN LA COMUNICACI√ìN:\s*(\d+)\/5/,"ATENCI√ìN Y ESCUCHA":/ATENCI√ìN Y ESCUCHA:\s*(\d+)\/5/,"SEGURIDAD TRANSMITIDA":/SEGURIDAD TRANSMITIDA:\s*(\d+)\/5/}).forEach(([t,a])=>{const n=e.match(a);if(n){const e=parseInt(n[1]);this.updateAspectRating(t,e)}})}updateAspectRating(e,t){if("NIVEL GENERAL DE COMODIDAD"===e)document.getElementById("treatmentCombo").value=t;else{const a={"EMPAT√çA":"Empat√≠a",RESPETO:"Respeto","CLARIDAD EN LA COMUNICACI√ìN":"Claridad","ATENCI√ìN Y ESCUCHA":"Atenci√≥n","SEGURIDAD TRANSMITIDA":"Seguridad"}[e];if(a){const e=document.querySelector(`[data-aspect="${a}"]`);e&&(e.value=t,e.nextElementSibling.textContent=t)}}}updateTechnicalFeedback(e){this.populateFeedbackBlocks(e)}populateFeedbackBlocks(e){["A","B","C","D","E"].forEach(t=>{const a=e.indexOf(`${t}. `);if(-1!==a){const n="E"===t?e.indexOf("NIVEL ALCANZADO:",a):e.indexOf(`${String.fromCharCode(t.charCodeAt(0)+1)}. `,a),i=-1!==n?e.substring(a,n).trim():e.substring(a).trim(),o=document.querySelector(`[data-letter="${t}"] .feedback-text`);o&&(o.textContent=i);const s=i.match(/NIVEL ALCANZADO:\s*(\d+)\/5/);if(s){const e=parseInt(s[1]),a=document.querySelector(`[data-letter="${t}"] .score-slider`),n=document.querySelector(`[data-letter="${t}"] .score-value`);a&&n&&(a.value=e,n.textContent=e)}}});const t=e.indexOf("PAREN");if(-1!==t){const a=e.substring(t),n=document.querySelector('[data-letter="PAREN"] .feedback-text');n&&(n.textContent=a)}}switchTab(e){document.querySelectorAll(".tab-pane").forEach(e=>{e.classList.remove("active")}),document.getElementById(e+"Tab").classList.add("active"),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-tab="${e}"]`).classList.add("active")}showSummary(){this.hideModal("feedbackWindow"),this.showModal("summaryWindow"),this.createCharts()}createCharts(){this.createPatientChart(),this.createTechnicalChart()}createPatientChart(){const e=document.getElementById("patientChart").getContext("2d"),t={labels:["Empat√≠a","Respeto","Comunicaci√≥n","Escucha","Seguridad","Comodidad"],datasets:[{label:"Evaluaci√≥n del Paciente",data:this.getPatientValues(),backgroundColor:"rgba(54, 162, 235, 0.2)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:2}]};new Chart(e,{type:"radar",data:t,options:{scales:{r:{beginAtZero:!0,max:5,ticks:{stepSize:1}}},plugins:{legend:{display:!1}}}})}createTechnicalChart(){const e=document.getElementById("technicalChart").getContext("2d"),t={labels:["Escucha Activa","Reentrenamiento Respiratorio","Clasificaci√≥n Necesidades","Derivaci√≥n Redes","Psicoeducaci√≥n"],datasets:[{label:"Evaluaci√≥n T√©cnica",data:this.getTechnicalValues(),backgroundColor:"rgba(255, 99, 132, 0.2)",borderColor:"rgba(255, 99, 132, 1)",borderWidth:2}]};new Chart(e,{type:"radar",data:t,options:{scales:{r:{beginAtZero:!0,max:5,ticks:{stepSize:1}}},plugins:{legend:{display:!1}}}})}getPatientValues(){const e=[];return document.querySelectorAll(".aspect-slider").forEach(t=>{e.push(parseInt(t.value))}),e.push(parseInt(document.getElementById("treatmentCombo").value)),e}getTechnicalValues(){const e=[];return["A","B","C","D","E"].forEach(t=>{const a=document.querySelector(`[data-letter="${t}"] .score-slider`);a?e.push(parseInt(a.value)):e.push(0)}),e}showLoading(e){document.getElementById("loadingText").textContent=e,document.getElementById("loadingIndicator").classList.remove("hidden")}hideLoading(){document.getElementById("loadingIndicator").classList.add("hidden")}showInfoMessage(e){console.log("[INFO]",e);const t=document.getElementById("pfaInfoToast");t&&t.remove();const a=document.createElement("div");a.id="pfaInfoToast",a.style.position="fixed",a.style.bottom="16px",a.style.right="16px",a.style.background="#1f2937",a.style.color="#fff",a.style.padding="12px 16px",a.style.borderRadius="8px",a.style.fontSize="14px",a.style.boxShadow="0 4px 16px rgba(0,0,0,0.3)",a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.remove()},5e3)}showResources(){this.showModal("resourcesDialog")}copySelectedResources(){const e=[];document.querySelectorAll('.resources-list input[type="checkbox"]:checked').forEach(t=>{e.push(t.value)}),e.length>0?navigator.clipboard.writeText(e.join("\n")).then(()=>{alert("Recursos copiados al portapapeles")}):alert("No hay recursos seleccionados")}applyResources(){const e=[];if(document.querySelectorAll('.resources-list input[type="checkbox"]:checked').forEach(t=>{e.push(t.value)}),e.length>0){document.getElementById("resourcesList").innerHTML=e.map(e=>`<div>‚Ä¢ ${e}</div>`).join(""),this.hideModal("resourcesDialog")}else alert("No hay recursos seleccionados")}setupFileUpload(){const e=document.getElementById("uploadDropZone"),t=document.getElementById("fileInput");document.getElementById("selectedFiles");e.addEventListener("click",()=>{t.click()}),t.addEventListener("change",e=>{this.handleFileSelection(e.target.files)}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover"),this.handleFileSelection(t.dataTransfer.files)})}handleFileSelection(e){const t=document.getElementById("selectedFiles");t.innerHTML="",Array.from(e).forEach(e=>{const a=this.createFileItem(e);t.appendChild(a)}),document.getElementById("fileList").style.display="block"}createFileItem(e){const t=document.createElement("div");t.className="file-item",t.dataset.fileName=e.name;const a=this.getFileIcon(e.type),n=this.formatFileSize(e.size);return t.innerHTML=`\n            <div class="file-info">\n                <div class="file-icon">${a}</div>\n                <div class="file-details">\n                    <div class="file-name">${e.name}</div>\n                    <div class="file-size">${n}</div>\n                </div>\n            </div>\n            <button class="file-remove" onclick="this.parentElement.remove()">\n                <i class="fas fa-times"></i>\n            </button>\n        `,t}getFileIcon(e){return e.startsWith("image/")?'<i class="fas fa-image"></i>':e.startsWith("video/")?'<i class="fas fa-video"></i>':e.startsWith("audio/")?'<i class="fas fa-music"></i>':e.includes("pdf")?'<i class="fas fa-file-pdf"></i>':e.includes("word")?'<i class="fas fa-file-word"></i>':e.includes("text")?'<i class="fas fa-file-alt"></i>':'<i class="fas fa-file"></i>'}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}uploadFiles(){const e=document.querySelectorAll("#selectedFiles .file-item");0!==e.length?e.forEach((t,a)=>{setTimeout(()=>{t.classList.add("uploading"),setTimeout(()=>{t.classList.remove("uploading"),t.classList.add("success");const n=t.dataset.fileName,i=document.getElementById("resourcesList"),o=i.innerHTML;i.innerHTML=o+`<div>‚Ä¢ üìé ${n}</div>`,a===e.length-1&&setTimeout(()=>{this.hideModal("uploadDialog"),alert("Archivos cargados exitosamente")},1e3)},1500)},500*a)}):alert("No hay archivos seleccionados para cargar")}exportConversation(){if(!this.conversationHistory.length)return void alert("No hay mensajes en la conversaci√≥n para exportar");const e=this.conversationHistory.filter(e=>"user"===e.role||"assistant"===e.role).map(e=>`${"user"===e.role?"Usuario":"Sobreviviente"}: ${e.content}`).join("\n\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="conversacion_pfa.txt",n.click(),URL.revokeObjectURL(a),alert("Conversaci√≥n exportada con √©xito")}finishFeedback(){this.hideModal("summaryWindow"),this.hideModal("feedbackWindow"),this.showModal("simulationConfigWindow"),this.conversationHistory=[],this.currentStage="config"}exitApplication(){confirm("¬øEst√° seguro de que desea salir?")&&window.close()}}function configureRandomSimulation(){const e=new URLSearchParams(window.location.search),t="true"===e.get("autostart"),a="true"===e.get("random"),n=e.get("mode");if(t&&a&&"student"===n){console.log("üéØ Configurando simulaci√≥n aleatoria para alumno...");const r=document.createElement("style");r.textContent="\n            #simulationConfigWindow {\n                display: none !important;\n            }\n            .modal.active#simulationConfigWindow {\n                display: none !important;\n            }\n        ",document.head.appendChild(r);const c={traumaType:["Agresi√≥n Sexual","Ataque F√≠sico","Conflicto Armado","Terrorismo","Desastre Natural","Accidente de Tr√°nsito","Accidente Dom√©stico","Condici√≥n m√©dica repentina","Noticias traum√°ticas repentinas","Incendio"],traumaSetting:["Casa","Escuela","Zona de combate","Lugar de trabajo","Calle","Naturaleza","Lugar p√∫blico"],age:["Joven Adulto","Ni√±o","Adolescente","Adulto","Anciano"],gender:["Femenino","Masculino","No especificado"],challenges:["P√©rdida de contacto con la realidad","Agresi√≥n auto/hetero-dirigida","Ausencia de respuesta a est√≠mulos","Tratamiento de salud mental actual o previo","S√≠ntomas invalidantes que no ceden"],education:["B√°sico","Secundaria","T√©cnico","Profesional","Postgrado"],civilStatus:["Soltero","En una relaci√≥n","Casado","Divorciado","Viudo"],network:["Sin familia ni red social","Red social/familiar restringida","Red social y lazos fuertes"],medicalConditions:["S√≠","No"],psychiatricConditions:["S√≠","No"],medications:["S√≠","No"]};function i(e){return e[Math.floor(Math.random()*e.length)]}function o(e,t){const a=document.getElementById(e);a&&(a.value=t,console.log(`‚úì ${e}: ${t}`))}function s(){const e=Math.floor(51*Math.random())+30;o("difficultySlider",e);const t=document.getElementById("difficultyValue");t&&(t.textContent=e+"%"),Object.keys(c).forEach(e=>{o(e,i(c[e]))});const a=document.getElementById("randomSimulation");a&&(a.checked=!0,console.log("‚úì Simulaci√≥n aleatoria activada"));document.querySelectorAll(".personality-slider").forEach(e=>{const t=10*Math.floor(11*Math.random());e.value=t;const a=e.parentNode.querySelector(".slider-value");a&&(a.textContent=t+"%")}),["livesWithOptions","hobbiesOptions"].forEach(e=>{const t=document.getElementById(e);if(t){const e=t.querySelectorAll('input[type="checkbox"]:not([value="Aleatorio"])'),a=Math.floor(3*Math.random())+1;Array.from(e).sort(()=>.5-Math.random()).slice(0,a).forEach(e=>e.checked=!0)}});o("providerName",i(["Dr. Garc√≠a","Dra. Rodr√≠guez","Dr. Mart√≠nez","Dra. L√≥pez","Dr. Gonz√°lez","Dra. P√©rez","Dr. S√°nchez","Dra. Ram√≠rez","Dr. Torres","Dra. Flores"])),console.log("üéØ Configuraci√≥n aleatoria completada"),setTimeout(()=>{if(window.pfaSimulator){console.log("üöÄ Iniciando simulaci√≥n autom√°ticamente (modo alumno)...");const e=window.pfaSimulator.getSimulationConfig();e.providerName&&(window.pfaSimulator.providerName=e.providerName,window.pfaSimulator.patientCharacteristics=e,window.pfaSimulator.showLoading("Esperando que la enfermera de triage le asigne un caso..."),window.pfaSimulator.createTraumaStory().catch(e=>{console.error("Error al crear la historia:",e),window.pfaSimulator.hideLoading(),alert("Error al generar la simulaci√≥n. Por favor, intente nuevamente.")}))}},500)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(s,500)}):setTimeout(s,500)}}!function(){if(window.pfaSimulator)return;const e=()=>{try{window.pfaSimulator||(window.pfaSimulator=new PFASimulator,window.PFA_BOOT_LOG&&window.PFA_BOOT_LOG.push("[init] PFASimulator instanciado OK (script.js)"),configureRandomSimulation())}catch(e){console.error("Error inicializando PFASimulator:",e),window.PFA_BOOT_LOG&&window.PFA_BOOT_LOG.push("[init-error] "+(e&&e.message?e.message:e))}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}();